name: Dependency Check

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        
    - name: Install pip-audit
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit pip-tools
        
    - name: Audit dependencies for vulnerabilities
      run: |
        pip-audit --desc --output pip-audit-report.json --format json || true
        pip-audit
        
    - name: Check for outdated packages
      run: |
        pip install -r requirements.txt
        pip list --outdated --format json > outdated-packages.json || true
        
        if [ -s outdated-packages.json ] && [ "$(cat outdated-packages.json)" != "[]" ]; then
          echo "ðŸ“¦ Outdated packages found:"
          python -c "
          import json
          with open('outdated-packages.json') as f:
              packages = json.load(f)
          for pkg in packages:
              print(f\"  {pkg['name']}: {pkg['version']} -> {pkg['latest_version']}\")
          "
        else
          echo "âœ… All packages are up to date"
        fi
        
    - name: Generate dependency tree
      run: |
        pip install pipdeptree
        pipdeptree --json > dependency-tree.json
        pipdeptree
        
    - name: Upload dependency reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          pip-audit-report.json
          outdated-packages.json
          dependency-tree.json
          
    - name: Create issue for vulnerabilities
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const title = 'ðŸš¨ Security vulnerabilities found in dependencies';
          const body = `
          ## Security Alert
          
          The dependency audit found security vulnerabilities in our project dependencies.
          
          ### Action Required
          - [ ] Review the pip-audit report in the Actions artifacts
          - [ ] Update vulnerable packages
          - [ ] Test the application after updates
          - [ ] Update requirements.txt
          
          ### Artifacts
          Check the \`dependency-reports\` artifact in this workflow run for detailed information.
          
          **Auto-generated by dependency-check workflow**
          `;
          
          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð°ÐºÐ¾Ð¹ issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['security', 'dependencies']
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('Security vulnerabilities found')
          );
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'dependencies', 'automated']
            });
          }
